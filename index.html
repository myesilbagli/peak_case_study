<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peak Product Case – Q2 & Q4</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --border: #2a2a32;
      --text: #e8e8ec;
      --muted: #8888a0;
      --accent-a: #2563eb;
      --accent-b: #dc2626;
      --success: #4ade80;
      --highlight: #fbbf24;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.25rem 0;
      letter-spacing: -0.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1.25rem;
    }
    .card h2 {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin: 0 0 0.75rem 0;
    }
    p {
      margin: 0 0 0.75rem 0;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .summary-box {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
    }
    .summary-box .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    .summary-box .value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      font-weight: 600;
    }
    .summary-box.winner-a { border-color: var(--accent-a); background: rgba(37, 99, 235, 0.08); }
    .summary-box.winner-b { border-color: var(--accent-b); background: rgba(220, 38, 38, 0.08); }
    .chart-wrap {
      position: relative;
      height: 260px;
      margin-top: 0.5rem;
    }
    .cohort-tables {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 0.75rem;
    }
    @media (max-width: 700px) { .cohort-tables { grid-template-columns: 1fr; } }
    .cohort-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
    }
    .cohort-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      font-family: 'JetBrains Mono', monospace;
    }
    .cohort-table th {
      padding: 0.4rem 0.35rem;
      text-align: right;
      background: var(--surface);
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .cohort-table th.row-header {
      text-align: left;
      min-width: 4rem;
      left: 0;
      z-index: 2;
      background: var(--surface);
    }
    .cohort-table td {
      padding: 0.3rem 0.35rem;
      text-align: right;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }
    .cohort-table td.row-header {
      text-align: left;
      font-weight: 500;
      color: var(--muted);
      position: sticky;
      left: 0;
      background: var(--bg);
      z-index: 1;
    }
    .cohort-table tr:hover td.row-header { background: var(--surface); }
    .cohort-table tr:hover td { background: rgba(255,255,255,0.03); }
    .cohort-table td.empty { color: var(--border); }
    .cohort-table .col-day-15 { background: rgba(251, 191, 36, 0.08); font-weight: 600; }
    .cohort-table th.col-day-15 { background: rgba(251, 191, 36, 0.15); }
    .footer {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--muted);
    }

    .tab-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      font-family: 'DM Sans', system-ui, sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
    }
    .tab-btn:hover {
      color: var(--text);
      background: var(--surface);
    }
    .tab-btn.active {
      color: var(--accent-a);
      background: rgba(37, 99, 235, 0.12);
      border-color: var(--accent-a);
    }
    .panel {
      display: none;
    }
    .panel.active {
      display: block;
    }
    .explain-block {
      background: var(--bg);
      border-radius: 8px;
      padding: 1rem 1.15rem;
      margin: 1rem 0;
      border-left: 3px solid var(--accent-a);
    }
    .explain-block h3 {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: var(--text);
    }
    .explain-block p, .explain-block ul {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.6;
    }
    .explain-block ul { padding-left: 1.25rem; }
    .explain-block li { margin-bottom: 0.25rem; }
    .explain-block p:last-child { margin-bottom: 0; }
    .takeaway {
      font-weight: 600;
      color: var(--highlight);
      margin-top: 0.75rem;
    }
    .part-c-charts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 0.75rem;
    }
    @media (max-width: 600px) { .part-c-charts { grid-template-columns: 1fr; } }

    .main-tab-bar {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.5rem 0;
      max-width: 900px;
      margin: 0 auto;
      border-bottom: 1px solid var(--border);
    }
    .main-tab-btn {
      font-family: 'DM Sans', system-ui, sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 0.6rem 1.25rem;
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: color 0.15s, background 0.15s, border-color 0.15s;
    }
    .main-tab-btn:hover { color: var(--text); background: var(--surface); }
    .main-tab-btn.active {
      color: var(--accent-a);
      background: rgba(37, 99, 235, 0.12);
      border-color: var(--accent-a);
    }
    .main-panel { display: none; }
    .main-panel.active { display: block; }

    .header-credit {
      position: fixed;
      top: 0;
      right: 0;
      padding: 0.6rem 1rem;
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
      z-index: 100;
    }
    .header-credit .name { font-weight: 600; color: var(--text); }

    .board-wrap { margin-top: 0.5rem; }
    .board {
      display: inline-grid;
      grid-template-columns: repeat(9, 2.25rem);
      grid-template-rows: repeat(9, 2.25rem);
      gap: 3px;
      font-size: 0.7rem;
      font-family: 'JetBrains Mono', monospace;
    }
    .cell {
      width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: var(--border);
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s;
      user-select: none;
    }
    .cell:hover { background: #3a3a45; color: var(--text); }
    .cell.combo { background: var(--accent-a); color: white; font-weight: 700; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5); }
    .cell.combo:hover { background: #1d4ed8; }
    .cell.affected { background: #1d4ed8; color: rgba(255,255,255,0.95); }
    .cell.affected:hover { background: #2563eb; }
    .cell.combo.affected { background: var(--accent-a); }
    .tiles-count { margin-top: 1rem; font-size: 1.1rem; font-weight: 600; color: var(--text); }
    .tiles-count .num { font-family: 'JetBrains Mono', monospace; color: var(--highlight); }
    .tiles-count .hint { font-weight: 400; font-size: 0.9rem; color: var(--muted); }
    .expected-note { margin-top: 1rem; font-size: 0.85rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="header-credit">
    <span class="name">Muhyiddin Yesilbagli</span><br>February 2026
  </div>
  <div class="main-tab-bar">
    <button type="button" class="main-tab-btn active" data-main-tab="q2">Q2 – 7×7 Combo</button>
    <button type="button" class="main-tab-btn" data-main-tab="q4">Q4 – A/B Metrics</button>
  </div>

  <div id="main-panel-q2" class="main-panel active">
    <div class="container" style="max-width: 720px;">
      <h1>Q2 – 7×7 Combo on 9×9 Board</h1>
      <p class="subtitle">Peak Product Case · Click any tile to see the blast</p>
      <div class="card">
        <h2>Interactive board</h2>
        <p>The combo affects a <strong>7×7</strong> area centered on the chosen tile. Click any tile below — that tile is the combo center. The board will show which tiles explode (purple) and how many are cleared. Near the borders, fewer than 49 tiles explode.</p>
        <div class="board-wrap">
          <div class="board" id="board"></div>
          <p class="tiles-count" id="tilesCount">Click a tile to see how many tiles explode.</p>
          <p class="expected-note" id="expectedNote"></p>
        </div>
      </div>
      <div class="footer">7×7 blast (center ±3 in each direction), clipped to the 9×9 board.</div>
    </div>
  </div>

  <div id="main-panel-q4" class="main-panel">
  <div class="container">
    <h1>Q4 – A/B Test Visualization</h1>
    <p class="subtitle">Peak Product Case · 10,000 installs/day · DAU, retention, revenue</p>

    <div class="tab-bar">
      <button type="button" class="tab-btn active" data-tab="general">General Analysis</button>
      <button type="button" class="tab-btn" data-tab="part-a">Part A</button>
      <button type="button" class="tab-btn" data-tab="part-b">Part B</button>
      <button type="button" class="tab-btn" data-tab="part-c">Part C</button>
      <button type="button" class="tab-btn" data-tab="part-d">Part D</button>
    </div>

    <!-- General Analysis -->
    <div id="panel-general" class="panel active">
      <div class="card">
        <h2>Retention (%) by day</h2>
        <p>Variant A has lower day-1 retention but flatter decay. Variant B starts higher but drops faster.</p>
        <div class="chart-wrap"><canvas id="chartRetention"></canvas></div>
      </div>
      <div class="card">
        <h2>DAU over time</h2>
        <p>Daily active users = 10,000 × sum of retention for all cohorts active that day. Day 15 is the Part A decision point.</p>
        <div class="chart-wrap"><canvas id="chartDAU"></canvas></div>
      </div>
      <div class="card">
        <h2>Cumulative revenue over time</h2>
        <p>ARPDAU = $0.50. Part B asks which variant has higher cumulative revenue by end of day 15.</p>
        <div class="chart-wrap"><canvas id="chartRevenue"></canvas></div>
      </div>
      <div class="card">
        <h2>Cohort tables – DAU contribution by install day</h2>
        <p>Each row is a cohort (install day). Each column is a calendar day. Cell = that cohort’s contribution to DAU on that day (10,000 × retention). Column 15 highlighted for Part A.</p>
        <div class="cohort-tables">
          <div>
            <div class="cohort-wrap">
              <table class="cohort-table" id="cohortTableA">
                <caption style="text-align:left; padding:0.5rem 0; color: var(--accent-a); font-weight: 600;">Variant A</caption>
              </table>
            </div>
          </div>
          <div>
            <div class="cohort-wrap">
              <table class="cohort-table" id="cohortTableB">
                <caption style="text-align:left; padding:0.5rem 0; color: var(--accent-b); font-weight: 600;">Variant B</caption>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Part A -->
    <div id="panel-part-a" class="panel">
      <div class="card">
        <h2>Part A – Maximize DAU on day 15</h2>

        <div class="explain-block">
          <h3>What are we even asking?</h3>
          <p>We want to know: on <strong>day 15</strong>, which variant has <strong>more people opening the app that day</strong>? That number is called DAU (Daily Active Users).</p>
        </div>

        <div class="explain-block">
          <h3>Where does day-15 DAU come from?</h3>
          <p>We add 10,000 new installs every day. So on day 15 we have 15 groups of users (cohorts):</p>
          <ul>
            <li>People who installed on <strong>day 1</strong> → on day 15 they’re “15 days in” → some % still play (that’s retention R(15)).</li>
            <li>People who installed on <strong>day 2</strong> → on day 15 they’re “14 days in” → R(14) still play.</li>
            <li>… same for day 3, 4, … 15.</li>
          </ul>
          <p>So <strong>DAU on day 15</strong> = 10,000 × [R(1) + R(2) + … + R(15)]. We add up retention for “1 day in”, “2 days in”, … “15 days in”, multiply by 10k.</p>
        </div>

        <div class="summary-grid">
          <div class="summary-box winner-a" id="partA">
            <div class="label">DAU on day 15</div>
            <div class="value" id="partAValue">—</div>
            <div class="label" style="margin-top:0.35rem;">Pick: <strong id="partAPick">—</strong></div>
          </div>
        </div>

        <div class="explain-block">
          <h3>Why does A win?</h3>
          <p>Variant B has <strong>higher retention at the start</strong> (e.g. 46% come back day 1 vs A’s 41%), but B’s retention <strong>drops faster</strong> over time. Variant A starts lower but <strong>holds on to people longer</strong>. By day 15 we’re adding up 15 cohorts; A’s “holds on longer” wins — more of those cohorts are still active, so total DAU is higher for A.</p>
          <p class="takeaway">Answer: Pick <strong id="partAPick2">—</strong>. See General Analysis for the DAU-over-time chart.</p>
        </div>
      </div>
    </div>

    <!-- Part B -->
    <div id="panel-part-b" class="panel">
      <div class="card">
        <h2>Part B – Maximize cumulative revenue by end of day 15</h2>

        <div class="explain-block">
          <h3>What are we asking?</h3>
          <p>This time the goal is <strong>money</strong>: by the end of day 15, which variant has made <strong>more total revenue</strong>? (We don’t care who wins on day 15 DAU — we care who made more cash in days 1–15 combined.)</p>
        </div>

        <div class="explain-block">
          <h3>How do we get revenue?</h3>
          <p>Each day: <strong>Revenue that day</strong> = (how many people played that day) × (how much we earn per active user). We’re told we earn <strong>$0.50 per active user per day</strong> (that’s ARPDAU). So:</p>
          <ul>
            <li>Day 1 revenue = DAU(1) × $0.50</li>
            <li>Day 2 revenue = DAU(2) × $0.50</li>
            <li>… same for every day up to 15.</li>
          </ul>
          <p><strong>Cumulative revenue by day 15</strong> = add up day 1 + day 2 + … + day 15 revenue.</p>
        </div>

        <div class="summary-grid">
          <div class="summary-box winner-b" id="partB">
            <div class="label">Cum. revenue by day 15</div>
            <div class="value" id="partBValue">—</div>
            <div class="label" style="margin-top:0.35rem;">Pick: <strong id="partBPick">—</strong></div>
          </div>
        </div>

        <div class="explain-block">
          <h3>Why does B win here (even though A won on day-15 DAU)?</h3>
          <p>B has <strong>stronger retention in the first days</strong> (way more people come back day 1, day 2, etc.). So in the <strong>first two weeks</strong>, B has higher DAU almost every day. More people playing = more revenue every day. We’re only counting revenue through day 15, so B’s “strong start” wins. A catches up later (that’s why A wins Part A), but that doesn’t help for “total money by day 15”.</p>
          <p class="takeaway">Answer: Pick <strong>B</strong>. See General Analysis for the cumulative revenue chart.</p>
        </div>
      </div>
    </div>

    <!-- Part C -->
    <div id="panel-part-c" class="panel">
      <div class="card">
        <h2>Part C – ARPDAU jump to $0.70, then drop back to $0.50</h2>

        <div class="explain-block">
          <h3>What’s different in this scenario?</h3>
          <p>Same installs and retention as before. But now we’re told: <strong>from day 15 onward</strong>, we earn <strong>$0.70 per active user per day</strong> (instead of $0.50). That bonus doesn’t last forever: it goes down in a straight line over 10 days and is back to $0.50 by day 25. So:</p>
          <ul>
            <li>Days 1–14: $0.50 per active user (unchanged).</li>
            <li>Day 15: $0.70.</li>
            <li>Day 16: $0.68, day 17: $0.66, … down to day 25: $0.50.</li>
            <li>Day 26 onward: $0.50 again.</li>
          </ul>
          <p>The question: which variant has <strong>more total revenue from day 1 through day 25</strong>?</p>
        </div>

        <div class="card" style="margin-top: 1rem;">
          <h2>What happens after day 15</h2>
          <p><strong>Left:</strong> ARPDAU jumps to $0.70 on day 15, then drops in a straight line to $0.50 by day 25. <strong>Right:</strong> Daily revenue (DAU × ARPDAU) for A vs B in that window — A has more DAU in this period, so A earns more each day during the bonus.</p>
          <div class="part-c-charts">
            <div>
              <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.35rem;">ARPDAU ($) from day 15 to 25</p>
              <div class="chart-wrap" style="height: 220px;"><canvas id="chartPartCArpdau"></canvas></div>
            </div>
            <div>
              <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 0.35rem;">Daily revenue ($) — bonus window</p>
              <div class="chart-wrap" style="height: 220px;"><canvas id="chartPartCRevenue"></canvas></div>
            </div>
          </div>
          <p style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--muted);">Cumulative revenue in the bonus window (day 15–25): A earns more because it has higher DAU every day, so the higher $/user adds up to a bigger total for A.</p>
        </div>

        <div class="summary-grid">
          <div class="summary-box winner-a" id="partC">
            <div class="label">Cum. revenue day 1–25</div>
            <div class="value" id="partCValue">—</div>
            <div class="label" style="margin-top:0.35rem;">Pick: <strong id="partCPick">—</strong></div>
          </div>
        </div>

        <div class="explain-block">
          <h3>Why does A win?</h3>
          <p>The extra money ($0.70 instead of $0.50) is earned on <strong>every active user on those days</strong>. So whoever has <strong>more DAU in the period day 15–25</strong> gets more of that bonus. We already know A has higher DAU in the second half (that’s why A won Part A). So when we apply the higher ARPDAU to those days, A gets a bigger revenue bump than B. Total revenue day 1–25 is higher for A.</p>
          <p class="takeaway">Answer: Pick <strong>A</strong>.</p>
        </div>
      </div>
    </div>

    <!-- Part D -->
    <div id="panel-part-d" class="panel">
      <div class="card">
        <h2>Part D – New install source from day 15 (3k new + 7k old)</h2>

        <div class="explain-block">
          <h3>What’s different here?</h3>
          <p>We still have <strong>10,000 installs per day</strong>. But from day 15 on, those 10k are split:</p>
          <ul>
            <li><strong>7,000</strong> from the same source as before (same retention curves we’ve been using).</li>
            <li><strong>3,000</strong> from a <strong>new</strong> marketing source (e.g. a new ad channel).</li>
          </ul>
          <p>The new source has <strong>different retention</strong> for A vs B. For the 3k new users, A keeps them a bit longer than B (the math is given in the case). ARPDAU is still $0.50. The question: which variant has <strong>more total revenue from day 1 through day 28</strong>?</p>
        </div>

        <div class="explain-block">
          <h3>How we calculate it</h3>
          <p>For each day we compute DAU the same way, but:</p>
          <ul>
            <li>Users who installed <strong>before day 15</strong> → still 10k per day with the original retention.</li>
            <li>Users who installed <strong>on day 15 or later</strong> → 7k follow the old retention curve, 3k follow the new-source retention curve (different for A and B).</li>
          </ul>
          <p>Then we multiply each day’s DAU by $0.50 and add everything up through day 28.</p>
        </div>

        <div class="summary-grid">
          <div class="summary-box winner-a" id="partD">
            <div class="label">Cum. revenue day 1–28</div>
            <div class="value" id="partDValue">—</div>
            <div class="label" style="margin-top:0.35rem;">Pick: <strong id="partDPick">—</strong></div>
          </div>
        </div>

        <div class="explain-block">
          <h3>Why does A win?</h3>
          <p>For the <strong>3,000 new-source users each day</strong>, variant A’s retention drops more slowly than B’s. So those 3k users contribute more DAU (and thus more revenue) over time for A. The 7k old-source users behave as before; the difference comes from how long we keep the 3k new users. A keeps them longer → more revenue by day 28.</p>
          <p class="takeaway">Answer: Pick <strong>A</strong>.</p>
        </div>
      </div>
    </div>

    <div class="footer">
      Same logic as <code>q4_ab_metrics.py</code>. Retention fit: R(x) = (a·ln(x)+b)/100 from (day 1, day 28) points.
    </div>
  </div>
  </div>

  <script>
    // -------- Q2: 7×7 combo board --------
    (function() {
      const N = 9;
      const RADIUS = 3;
      function cellsAffected7x7(r, c) {
        const rLo = Math.max(0, r - RADIUS), rHi = Math.min(N - 1, r + RADIUS);
        const cLo = Math.max(0, c - RADIUS), cHi = Math.min(N - 1, c + RADIUS);
        return (rHi - rLo + 1) * (cHi - cLo + 1);
      }
      function getAffectedSet(comboR, comboC) {
        const set = new Set();
        const rLo = Math.max(0, comboR - RADIUS), rHi = Math.min(N - 1, comboR + RADIUS);
        const cLo = Math.max(0, comboC - RADIUS), cHi = Math.min(N - 1, comboC + RADIUS);
        for (let i = rLo; i <= rHi; i++)
          for (let j = cLo; j <= cHi; j++) set.add(i * N + j);
        return set;
      }
      function exactExpected7x7() {
        let total = 0;
        for (let i = 0; i < N; i++)
          for (let j = 0; j < N; j++) total += cellsAffected7x7(i, j);
        return total / (N * N);
      }
      function renderBoard(selectedR, selectedC) {
        const board = document.getElementById('board');
        if (!board) return;
        const hasSelection = selectedR !== null && selectedC !== null;
        const affected = hasSelection ? getAffectedSet(selectedR, selectedC) : new Set();
        const count = hasSelection ? cellsAffected7x7(selectedR, selectedC) : 0;
        board.innerHTML = '';
        for (let i = 0; i < N; i++) {
          for (let j = 0; j < N; j++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.row = i;
            cell.dataset.col = j;
            const idx = i * N + j;
            if (hasSelection && i === selectedR && j === selectedC) cell.classList.add('combo');
            if (hasSelection && affected.has(idx)) cell.classList.add('affected');
            cell.textContent = '';
            cell.title = 'Row ' + i + ', Col ' + j + '. Click to set as combo center.';
            board.appendChild(cell);
          }
        }
        const countEl = document.getElementById('tilesCount');
        const noteEl = document.getElementById('expectedNote');
        if (countEl) {
          if (hasSelection) countEl.innerHTML = '<span class="num">' + count + '</span> tile' + (count !== 1 ? 's' : '') + ' will explode <span class="hint">(combo at row ' + selectedR + ', col ' + selectedC + ')</span>';
          else countEl.textContent = 'Click a tile to see how many tiles explode.';
        }
        if (noteEl) noteEl.textContent = 'Expected tiles cleared (if combo is random): ' + exactExpected7x7().toFixed(2) + ' per combo.';
      }
      const boardEl = document.getElementById('board');
      if (boardEl) {
        boardEl.addEventListener('click', function(e) {
          const cell = e.target.closest('.cell');
          if (!cell) return;
          renderBoard(parseInt(cell.dataset.row, 10), parseInt(cell.dataset.col, 10));
        });
      }
      renderBoard(null, null);
    })();

    const INSTALLS = 10000;
    const ARPDAU = 0.50;

    // Fit R(x) = (a*ln(x)+b)/100 using (1, y1) and (28, y28)
    function fitRetention(y1, y28) {
      const a = (y28 - y1) / (Math.log(28) - Math.log(1));
      const b = y1 - a * Math.log(1);
      return function(x) {
        if (x < 1) return 0;
        return (a * Math.log(x) + b) / 100;
      };
    }

    const R_A = fitRetention(41, 36.33);
    const R_B = fitRetention(46, 31.67);

    function dau(day, R) {
      let sum = 0;
      for (let k = 1; k <= day; k++) sum += R(k);
      return INSTALLS * sum;
    }

    function cumRevenue(throughDay, R) {
      let total = 0;
      for (let d = 1; d <= throughDay; d++)
        total += dau(d, R) * ARPDAU;
      return total;
    }

    // Part C: ARPDAU = 0.50 until day 15, then 0.70 linear down to 0.50 by day 25, then 0.50
    function arpdauPartC(day) {
      if (day < 15) return 0.50;
      if (day <= 25) return 0.70 - (day - 15) * (0.20 / 10);
      return 0.50;
    }
    function cumRevenuePartC(throughDay, R) {
      let total = 0;
      for (let d = 1; d <= throughDay; d++)
        total += dau(d, R) * arpdauPartC(d);
      return total;
    }

    // Part D: From day 15, 7k old + 3k new per day. New retention A: (-2.1*ln(x)+48)/100, B: (-5.1*ln(x)+53)/100
    const R_A_new = x => (x >= 1 ? (-2.1 * Math.log(x) + 48) / 100 : 0);
    const R_B_new = x => (x >= 1 ? (-5.1 * Math.log(x) + 53) / 100 : 0);
    const OLD_INSTALLS = 7000;
    const NEW_INSTALLS = 3000;
    const SWITCH_DAY = 15;

    function dauMixed(day, R_old, R_new) {
      let total = 0;
      for (let installDay = 0; installDay < day; installDay++) {
        const daysSince = day - installDay;
        if (daysSince < 1) continue;
        if (installDay < SWITCH_DAY)
          total += INSTALLS * R_old(daysSince);
        else
          total += OLD_INSTALLS * R_old(daysSince) + NEW_INSTALLS * R_new(daysSince);
      }
      return total;
    }
    function cumRevenuePartD(throughDay, R_old, R_new) {
      let total = 0;
      for (let d = 1; d <= throughDay; d++)
        total += dauMixed(d, R_old, R_new) * ARPDAU;
      return total;
    }

    const days = [];
    for (let i = 1; i <= 28; i++) days.push(i);

    const retentionA = days.map(d => Math.round(R_A(d) * 10000) / 100);
    const retentionB = days.map(d => Math.round(R_B(d) * 10000) / 100);
    const dauA = days.map(d => dau(d, R_A));
    const dauB = days.map(d => dau(d, R_B));
    const cumRevA = days.map(d => cumRevenue(d, R_A));
    const cumRevB = days.map(d => cumRevenue(d, R_B));

    const dau15_A = dau(15, R_A);
    const dau15_B = dau(15, R_B);
    const rev15_A = cumRevenue(15, R_A);
    const rev15_B = cumRevenue(15, R_B);

    const partAPick = dau15_A >= dau15_B ? 'A' : 'B';
    const partBPick = rev15_A >= rev15_B ? 'A' : 'B';

    const rev25_A_c = cumRevenuePartC(25, R_A);
    const rev25_B_c = cumRevenuePartC(25, R_B);
    const partCPick = rev25_A_c >= rev25_B_c ? 'A' : 'B';

    const rev28_A_d = cumRevenuePartD(28, R_A, R_A_new);
    const rev28_B_d = cumRevenuePartD(28, R_B, R_B_new);
    const partDPick = rev28_A_d >= rev28_B_d ? 'A' : 'B';

    document.getElementById('partAValue').textContent =
      `A: ${dau15_A.toLocaleString(undefined, { maximumFractionDigits: 0 })} · B: ${dau15_B.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
    document.getElementById('partAPick').textContent = partAPick;
    const partAPick2El = document.getElementById('partAPick2');
    if (partAPick2El) partAPick2El.textContent = partAPick;
    document.getElementById('partBValue').textContent =
      `A: $${(rev15_A/1000).toFixed(0)}k · B: $${(rev15_B/1000).toFixed(0)}k`;
    document.getElementById('partBPick').textContent = partBPick;

    document.getElementById('partA').classList.remove('winner-a', 'winner-b');
    document.getElementById('partA').classList.add(partAPick === 'A' ? 'winner-a' : 'winner-b');
    document.getElementById('partB').classList.remove('winner-a', 'winner-b');
    document.getElementById('partB').classList.add(partBPick === 'A' ? 'winner-a' : 'winner-b');

    document.getElementById('partCValue').textContent =
      'A: $' + (rev25_A_c/1000).toFixed(0) + 'k · B: $' + (rev25_B_c/1000).toFixed(0) + 'k';
    document.getElementById('partCPick').textContent = partCPick;
    document.getElementById('partC').classList.remove('winner-a', 'winner-b');
    document.getElementById('partC').classList.add(partCPick === 'A' ? 'winner-a' : 'winner-b');

    document.getElementById('partDValue').textContent =
      'A: $' + (rev28_A_d/1000).toFixed(0) + 'k · B: $' + (rev28_B_d/1000).toFixed(0) + 'k';
    document.getElementById('partDPick').textContent = partDPick;
    document.getElementById('partD').classList.remove('winner-a', 'winner-b');
    document.getElementById('partD').classList.add(partDPick === 'A' ? 'winner-a' : 'winner-b');

    function buildCohortTable(R, maxDay) {
      let html = '<thead><tr><th class="row-header">Cohort</th>';
      for (let d = 1; d <= maxDay; d++)
        html += '<th class="' + (d === 15 ? 'col-day-15' : '') + '">' + d + '</th>';
      html += '</tr></thead><tbody>';
      for (let installDay = 1; installDay <= maxDay; installDay++) {
        html += '<tr><td class="row-header">Day ' + installDay + '</td>';
        for (let calDay = 1; calDay <= maxDay; calDay++) {
          const daysSince = calDay - installDay + 1;
          const cls = (calDay === 15 ? ' col-day-15' : '') + (daysSince < 1 ? ' empty' : '');
          const val = daysSince >= 1
            ? (INSTALLS * R(daysSince)).toLocaleString(undefined, { maximumFractionDigits: 0 })
            : '—';
          html += '<td class="' + cls.trim() + '">' + val + '</td>';
        }
        html += '</tr>';
      }
      html += '</tbody>';
      return html;
    }

    document.getElementById('cohortTableA').innerHTML += buildCohortTable(R_A, 15);
    document.getElementById('cohortTableB').innerHTML += buildCohortTable(R_B, 15);

    const gridColor = 'rgba(136, 136, 160, 0.2)';
    const fontColor = '#e8e8ec';
    const fontMuted = '#8888a0';

    let chartRetention, chartDAU, chartRevenue, chartPartCArpdau, chartPartCRevenue;

    chartRetention = new Chart(document.getElementById('chartRetention'), {
      type: 'line',
      data: {
        labels: days,
        datasets: [
          { label: 'Variant A', data: retentionA, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.2, pointRadius: 0 },
          { label: 'Variant B', data: retentionB, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.2, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: fontColor } } },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: fontMuted, maxTicksLimit: 14 } },
          y: { grid: { color: gridColor }, ticks: { color: fontMuted }, min: 30, max: 50 }
        }
      }
    });

    chartDAU = new Chart(document.getElementById('chartDAU'), {
      type: 'line',
      data: {
        labels: days,
        datasets: [
          { label: 'Variant A', data: dauA, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.08)', fill: true, tension: 0.2, pointRadius: 0 },
          { label: 'Variant B', data: dauB, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.08)', fill: true, tension: 0.2, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: fontColor } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + Math.round(ctx.raw).toLocaleString() } }
        },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: fontMuted, maxTicksLimit: 14 } },
          y: { grid: { color: gridColor }, ticks: { color: fontMuted, callback: v => v >= 1000 ? (v/1000)+'k' : v } }
        }
      },
      plugins: [{
        id: 'vline15',
        beforeDraw(chart) {
          const ctx = chart.ctx;
          const xAxis = chart.scales.x;
          const x = xAxis.getPixelForValue(15);
          if (x < chart.chartArea.left || x > chart.chartArea.right) return;
          ctx.save();
          ctx.strokeStyle = 'rgba(251, 191, 36, 0.7)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(x, chart.chartArea.top);
          ctx.lineTo(x, chart.chartArea.bottom);
          ctx.stroke();
          ctx.restore();
          ctx.fillStyle = 'rgba(251, 191, 36, 0.7)';
          ctx.font = '11px DM Sans';
          ctx.fillText('day 15', x + 4, chart.chartArea.top + 12);
        }
      }]
    });

    chartRevenue = new Chart(document.getElementById('chartRevenue'), {
      type: 'line',
      data: {
        labels: days,
        datasets: [
          { label: 'Variant A', data: cumRevA, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.08)', fill: true, tension: 0.2, pointRadius: 0 },
          { label: 'Variant B', data: cumRevB, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.08)', fill: true, tension: 0.2, pointRadius: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: fontColor } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + Math.round(ctx.raw).toLocaleString() } }
        },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: fontMuted, maxTicksLimit: 14 } },
          y: { grid: { color: gridColor }, ticks: { color: fontMuted, callback: v => '$' + (v/1000) + 'k' } }
        }
      },
      plugins: [{
        id: 'vline15rev',
        beforeDraw(chart) {
          const ctx = chart.ctx;
          const xAxis = chart.scales.x;
          const x = xAxis.getPixelForValue(15);
          if (x < chart.chartArea.left || x > chart.chartArea.right) return;
          ctx.save();
          ctx.strokeStyle = 'rgba(251, 191, 36, 0.7)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.beginPath();
          ctx.moveTo(x, chart.chartArea.top);
          ctx.lineTo(x, chart.chartArea.bottom);
          ctx.stroke();
          ctx.restore();
          ctx.fillStyle = 'rgba(251, 191, 36, 0.7)';
          ctx.font = '11px DM Sans';
          ctx.fillText('day 15', x + 4, chart.chartArea.top + 12);
        }
      }]
    });

    // Part C: focus on days 15–25 (ARPDAU bump)
    const days15to25 = [];
    for (let i = 15; i <= 25; i++) days15to25.push(i);
    const arpdauC = days15to25.map(d => arpdauPartC(d));
    const dailyRevA_C = days15to25.map(d => dau(d, R_A) * arpdauPartC(d));
    const dailyRevB_C = days15to25.map(d => dau(d, R_B) * arpdauPartC(d));

    chartPartCArpdau = new Chart(document.getElementById('chartPartCArpdau'), {
      type: 'line',
      data: {
        labels: days15to25,
        datasets: [{
          label: 'ARPDAU ($)',
          data: arpdauC,
          borderColor: '#fbbf24',
          backgroundColor: 'rgba(251, 191, 36, 0.15)',
          fill: true,
          tension: 0,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: fontColor } } },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: fontMuted } },
          y: {
            grid: { color: gridColor },
            ticks: { color: fontMuted, callback: v => '$' + v.toFixed(2) },
            min: 0.45,
            max: 0.75
          }
        }
      }
    });

    chartPartCRevenue = new Chart(document.getElementById('chartPartCRevenue'), {
      type: 'line',
      data: {
        labels: days15to25,
        datasets: [
          { label: 'Variant A', data: dailyRevA_C, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.2, pointRadius: 2 },
          { label: 'Variant B', data: dailyRevB_C, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', fill: true, tension: 0.2, pointRadius: 2 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: fontColor } },
          tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': $' + Math.round(ctx.raw).toLocaleString() } }
        },
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: fontMuted } },
          y: { grid: { color: gridColor }, ticks: { color: fontMuted, callback: v => '$' + (v/1000).toFixed(0) + 'k' } }
        }
      }
    });

    function showPanel(tabId) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const panel = document.getElementById('panel-' + tabId);
      const btn = document.querySelector('.tab-btn[data-tab="' + tabId + '"]');
      if (panel) panel.classList.add('active');
      if (btn) btn.classList.add('active');
      if (tabId === 'general' && chartRetention && chartDAU && chartRevenue) {
        setTimeout(function() {
          chartRetention.resize();
          chartDAU.resize();
          chartRevenue.resize();
        }, 50);
      }
      if (tabId === 'part-c' && chartPartCArpdau && chartPartCRevenue) {
        setTimeout(function() {
          chartPartCArpdau.resize();
          chartPartCRevenue.resize();
        }, 50);
      }
    }

    document.querySelectorAll('.tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        showPanel(btn.getAttribute('data-tab'));
      });
    });

    function resizeQ4Charts() {
      if (typeof chartRetention !== 'undefined' && chartRetention) chartRetention.resize();
      if (typeof chartDAU !== 'undefined' && chartDAU) chartDAU.resize();
      if (typeof chartRevenue !== 'undefined' && chartRevenue) chartRevenue.resize();
      if (typeof chartPartCArpdau !== 'undefined' && chartPartCArpdau) chartPartCArpdau.resize();
      if (typeof chartPartCRevenue !== 'undefined' && chartPartCRevenue) chartPartCRevenue.resize();
    }

    document.querySelectorAll('.main-tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const tab = btn.getAttribute('data-main-tab');
        document.querySelectorAll('.main-tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.main-panel').forEach(function(p) { p.classList.remove('active'); });
        btn.classList.add('active');
        const panel = document.getElementById('main-panel-' + tab);
        if (panel) panel.classList.add('active');
        if (tab === 'q4') setTimeout(resizeQ4Charts, 100);
      });
    });
  </script>
</body>
</html>
